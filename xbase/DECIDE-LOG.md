# xSkills 决策记录

---

## D-001 共享模板注入方式：DCI `!`cat`` 预处理

**日期**：2026-02-15

**背景**：7 个工作流 skill 共享阶段 0 标准流程（prep-steps.md）。之前用"先读取 xxx 并按步骤执行"的引用方式，依赖 Claude 主动去读外部文件，不可靠。

**选项**：
1. 手动内联 — 把模板内容复制到每个 SKILL.md（7 份副本，维护困难）
2. 引用+写清楚 — 保持引用，把模板写得足够清晰（已验证不可靠）
3. `!`cat`` DCI 注入 — 用 `!`cat path`` 预处理，skill 加载时自动注入模板内容

**结论**：选项 3。单一源文件 + 自动注入 + Claude 看到完整内容，三个问题同时解决。

---

## D-002 共享模板只提取阶段 0 流程

**日期**：2026-02-15

**背景**：分析了 7 个 SKILL.md 所有段落的共享内容，评估哪些值得提取成公用模板。

**分析**：
- 阶段 0 标准流程 — 7/7 重复，~60 行 → 值得
- 参数处理"执行顺序"说明 — 7/7 但仅 1 行 → 不值得
- 预加载命令 — 7/7 但含 skill 名变量 → 无法模板化
- 关键原则共享条目 — 6-7/7 但仅 2 行 → 不值得
- 三态检测逻辑 — 7/7 但判断条件各异 → 无法模板化

**结论**：唯一值得 DCI 注入的共享模板 = prep-steps.md。其他共享内容太短或含 skill 特有参数。

---

## D-003 phase0 模板精简：从 5 步缩为 3 步

**日期**：2026-02-15

**背景**：原模板有 5 步（跳过检查→项目探测→产出物搜索→写入状态→去重），62 行。分析发现步骤 4（写入状态）和步骤 5（去重）与各 skill 特有步骤中的"写入"和"去重"重复。

**选项**：
1. 从各 skill 特有步骤中删掉写入/去重（模板统一处理）
2. 从模板中删掉步骤 4/5（各 skill 自己处理）

**结论**：选项 2。各 skill 的写入参数和去重规则各不相同，已经写在各自 SKILL.md 里，改动量最小。模板从 62 行缩为 31 行。

---

## D-004 优化顺序：先三个样本，再推广全部

**日期**：2026-02-15

**背景**：需要优化 phase0 模板、dedup 模板、以及 7 个 SKILL.md 的注入改造。

**结论**：先用 phase0 模板 + dedup 模板 + xtest 三个作为样本完成优化验证，再推广到全部 7 个 skill。降低一次性改动的风险。

---

## D-005 集中初始化：所有 skill 的阶段 0 由 xbase 统一执行

**日期**：2026-02-15

**背景**：各 skill 各自实现阶段 0（项目探测 + 产出物创建 + 调试基础设施等），导致：1) 重复逻辑分散在 7 个 SKILL.md 中；2) 跨 skill 依赖无法满足（如 xtest 需要 xdebug 创建的 run.sh，但无法调用 xdebug）；3) 新增 skill 要重写完整的阶段 0。

**选项**：
1. 各 skill 各管各的 — 现状，存在跨 skill 依赖问题
2. 集中初始化 — xbase 负责所有初始化，各 skill 只写 `references/init-steps.md`，xbase 通过 DCI 注入执行；未初始化的 skill 自动触发 `/xbase`
3. 共享初始化库 — 提取公共函数但各 skill 仍自行调用

**验证**：已实测 skill 嵌套调用可行（`_test-caller` 成功通过 Skill 工具调用 `_test-callee`），需在 `allowed-tools` 中加入 `"Skill"`。

**结论**：选项 2。单一入口管理所有初始化，新增 skill 只需写一个 init-steps.md 并注册。各 skill 检测到未初始化时自动调用 `/xbase init`。

**修订（2026-02-15）**：实测发现 skill 嵌套调用后**不会自动返回调用方**（Skill 工具加载新 SKILL.md 会替换当前上下文）。调整为选项 4：

4. **双轨初始化** — 每个 skill 的特有初始化步骤提取到 `references/init-steps.md`。两条路径共用同一份文件：
   - **独立路径**：各 skill 阶段 0 通过 DCI 注入 `prep-steps.md`（共享）+ 自己的 `init-steps.md`（特有），可独立完成初始化
   - **批量路径**：`/xbase init` 用 Task 子 agent 并行读取各 skill 的 `init-steps.md` 执行
   - **共享基础设施**（如 run.sh）提升到 `prep-steps.md`，所有 skill 共享

效果：新增 skill 只需写 init-steps.md；跨 skill 依赖通过共享模板解决；无需 skill 嵌套。

# 探测协议

> 输入：项目文件系统 + SKILL-STATE.md 已有状态。输出：每个核心文件的四态分类 + 候选路径表。副作用：无（只读阶段）。

核心文件指 skill 管理的所有文件（.md 文档、.sh 脚本等）。对 .md 核心文件执行三路并行搜索；非 .md 核心文件在各 skill 探测声明中定义检测方式。

三路搜索说明——每路有盲区，缺任何一路都可能漏文件：

| 搜索路径 | 方法 | 盲区 |
|---------|------|------|
| 精确名 | Glob 按标准文件名 | 漏：改过名的文件 |
| 指纹 | Grep 按内容特征 | 漏：内容已变或为空的文件 |
| 模糊名 | Glob 按相关关键词 | 漏：名称无相关关键词的文件 |

按以下规则执行：

1. **同批并行发出** — 三路 Glob/Grep 必须在同一批 tool call 中发出，禁止看到某路结果后再决定是否跑其余
2. **收齐后再判定** — 汇总去重（排除 `.claude/`、`node_modules/`、`.git/`、`build/`、`target/`、`vendor/`、`DerivedData/`），对每个候选用内容指纹 regex 判定是否匹配格式
3. **优先级** — doc_dir 内 > 项目根 > 其他；精确文件名 > 非精确；已就绪 > 迁移候选
4. **冲突处理** — 多个已就绪且优先级有差距 → 自动选高优，低优标记废弃候选；同级冲突 → AskUserQuestion 选规范文件
5. **无候选** → 需创建

展示原始命中表（确保三路都有数值，0 也要写）：

```
| 核心文件 | 精确名 | 指纹 | 模糊名 | 去重后候选 |
|---------|-------|------|-------|-----------|
| DEBUG-LOG.md | 1 | 1 | 2 | 2 |
```

根据命中结果，对每个候选文件判定四态：

| 状态 | 判定条件 |
|------|---------|
| 已就绪 | 内容指纹命中，且 skill 未声明更新触发条件 |
| 需更新 | 内容指纹命中，但 skill 声明的更新触发条件成立（如 git diff 有变更） |
| 迁移候选 | 指纹未命中，但有实质内容 |
| 需创建 | 无候选或文件为空 |

各 skill 在探测声明中用 `更新触发` 标注条件；未标注的核心文件，指纹命中即为"已就绪"。

以下为各核心文件的探测声明：

---
name: xdebug
description: 命令行调试工作流。用户描述 Bug 或输入 /xdebug 时激活。自动构建运行 App、捕获日志、引导复现、定位修复，全程选项驱动。
allowed-tools: ["Bash", "Read", "Edit", "Write", "Grep", "Glob", "AskUserQuestion", "Task"]
---

# 命令行调试工作流

## 目录

- [阶段 0：探测项目](#阶段-0探测项目)
- [阶段 1：确认问题](#阶段-1确认问题)
- [阶段 2：加日志 + 构建 + 运行](#阶段-2加日志--构建--运行)
- [阶段 3：引导用户操作](#阶段-3引导用户操作)
- [阶段 4：分析日志](#阶段-4分析日志)
- [阶段 5：修复 + 验证](#阶段-5修复--验证)
- [阶段 6：收尾](#阶段-6收尾)
- [关键原则](#关键原则)

## 启动方式

- 用户输入 `/xdebug` 或描述一个 Bug 时激活
- `/xdebug reinit` — 强制重新初始化（删除 SKILL-STATE.md 中 `## xdebug` 段 + 重新执行阶段 0）

## 流程

### 阶段 0：探测项目

> **快速跳过**：运行 `python3 .claude/skills/xbase/skill-state.py check xdebug`。
> - 输出 `initialized` → 运行 `python3 .claude/skills/xbase/skill-state.py read` 获取已有信息 → **跳过整个阶段 0**
> - 输出 `not_found` → 执行下方完整探测流程

1. **项目探测**：按 xbase skill 中的标准流程执行（扫描项目、读 CLAUDE.md、确定项目关键信息）
2. **验证并补齐调试基础设施**：

   后续阶段需要四项能力：构建、后台启动、日志捕获、停止。逐项检查，缺失的自动创建：

   - **构建**：通常已有（从 CLAUDE.md 或构建配置推导），验证命令可执行
   - **后台启动 + 日志捕获 + 停止**：检查是否有调试运行脚本（如 `scripts/run.sh`）
     - **已有且功能完备**（支持启动、日志捕获、停止）→ 直接使用
     - **缺失或不完备** → 根据项目类型自动创建，需支持：
       - `build` — 完整构建流程
       - `start` — 后台启动项目，日志捕获到文件（根据日志系统：stdout → 重定向；系统日志 → 过滤+重定向；日志框架 → 配置文件输出）。以能捕获输出的方式启动（如直接运行二进制而非 GUI launcher）
       - `stop` — 停止项目及相关后台进程
       - `logs [filter]` — 读取日志，支持过滤。根据项目日志格式实现：级别过滤（如 `warning` 显示 warning 及以上）、来源/模块过滤（如果日志格式中有来源标识）、任意关键词搜索
       - `status` — 检查运行状态
     - 脚本放在 `scripts/` 下，创建后不问用户
   - **创建或修改后必须验证**：运行脚本的 `build` 和 `status`（或等价命令）确认可用。验证失败则修复后重试

   后续阶段的"构建""启动""读日志""停止"均通过此基础设施执行，不再各自拼命令。

3. 检测调试日志文件（DEBUG_LOG.md），判断状态：
   - **不存在** → 在项目文档目录创建（格式见 `references/debug-log-format.md`）
   - **存在但格式不符** → 用 AskUserQuestion 询问是否迁移（保留原始内容，套用新格式）
   - **存在且格式正确** → 跳过，无需操作

4. **写入 SKILL-STATE.md**：按 xbase 规范，用脚本写入：
   ```bash
   python3 .claude/skills/xbase/skill-state.py write-info 类型 "<类型>" 构建命令 "<命令>" 运行脚本 "<脚本>" 日志位置 "<路径>"
   python3 .claude/skills/xbase/skill-state.py write xdebug debug_log "<DEBUG_LOG.md 路径>"
   ```

### 阶段 1：确认问题

> 从其他 skill 衔接且 Bug 已知时（如 `/xtest` 通过 `## 当前任务` 传递了失败描述），跳过此阶段，直接进入阶段 2。

用 AskUserQuestion，一步到位。**同时后台启动构建**（用户思考的时间不浪费）：

```
问题：这次调试什么？
选项：
- 探索性测试（先跑起来看日志）
- 继续上次调试
- Other → 用户直接输入 Bug 描述
```

### 阶段 2：加日志 + 构建 + 运行

**此阶段不问用户，全部自动完成：**

1. 判断现有日志是否足够覆盖问题区域（先查 LOG-COVERAGE.md，再读相关代码确认）
   - 覆盖足够 → 直接构建运行
   - 覆盖不足 → 用 `task set` 写入目标后启动子 agent：
     ```bash
     python3 .claude/skills/xbase/skill-state.py task set xdebug "<目标文件>" "<问题描述>"
     ```
     启动子 agent（Task 工具），让它读取 `.claude/skills/xlog/SKILL.md` 并按 `/xlog` 流程给目标区域补日志。子 agent 完成后主流程继续
2. 执行构建命令（从阶段 0 推导）
3. 编译失败 → 自己修复后重试，不问用户
4. 停止旧进程，后台启动项目，日志输出到阶段 0 确定的位置

### 阶段 3：引导用户操作

用 AskUserQuestion，**根据具体 Bug 给出操作步骤**，不要泛泛说"请操作"。

示例：如果 Bug 是"拖拽元素时位置偏移"，则：

```
问题：App 已启动，请按以下步骤操作：
  1. 创建一个元素
  2. 拖动它到右侧
  3. 观察位置是否偏移
  操作完选择：
选项：
- 操作完了，看日志
- 问题没复现
- App 崩溃了 / 没启动
```

### 阶段 4：分析日志

1. 读取日志：通过运行脚本的 `logs` 命令读取，**先用级别/模块过滤缩小范围**，再按需关键词搜索。不要一次读全量日志
2. 用 AskUserQuestion 展示分析结论（**App 保持运行，不要停**）：

```
问题：[简短分析摘要]。下一步？
选项：
- 已定位，修复代码
- 日志不够，加日志再来一轮（→ 回到阶段 2）
- 放弃，记录到 TODO
- Other → 用户补充信息
```

### 阶段 5：修复 + 验证

1. 停止项目（改代码前才停）
2. 修改代码修复 Bug
3. 删除临时诊断日志（保留有长期价值的日志）
4. 重新构建 + 后台启动项目（同阶段 2）
5. 用 AskUserQuestion，**同样给出具体验证步骤**：

```
问题：已修复并重启，请验证：
  [具体验证操作步骤]
选项：
- 修好了
- 没修好，继续调（→ 回到阶段 2）
- Other → 修好了但发现新问题，请描述
```

### 阶段 6：收尾

**仅在确认修好后执行，不问用户：**

1. 停止项目
2. 在 DEBUG_LOG.md 追加本次 Bug 修复记录（格式见 `references/debug-log-format.md`）
3. 如涉及技术决策且项目有决策记录文档，更新记录
4. 清除衔接任务：`python3 .claude/skills/xbase/skill-state.py task clear`

如果用户描述了新问题 → 以新问题回到阶段 1。

---

## 关键原则

- **不硬编码** — 构建命令、路径、日志系统均从项目动态推导
- **选项优先于打字** — 能用选项就不让用户打字，Other 兜底自由输入
- **操作步骤要具体** — 根据 Bug 给出 1-2-3 步骤，不要说"请操作复现"
- **每轮只问一个问题** — 不堆叠多个问题
- **先加日志后改代码** — 禁止盲猜
- **加日志委派子 agent** — 子 agent 读 `/xlog` SKILL.md 执行，主流程不中断
- **App 不要提前停** — 分析日志时保持运行，确认要改代码了再停
- **编译问题自己解决** — 编译失败不问用户
- **没修好不更新文档** — 只在确认修复后更新

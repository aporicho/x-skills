---
name: xdecide
description: 决策记录工作流。用户输入 /xdecide 时激活。引导决策过程、快速录入、回顾修订，维护决策记录文件。
allowed-tools: ["Bash", "Read", "Edit", "Write", "Grep", "Glob", "AskUserQuestion"]
argument-hint: "[决策描述 | review | reinit]"
---

# 决策记录工作流

## 目录

- [阶段 0：探测项目](#阶段-0探测项目)
- [阶段 1：选择模式](#阶段-1选择模式)
- [阶段 2a：引导式决策](#阶段-2a引导式决策)
- [阶段 2b：快速录入](#阶段-2b快速录入)
- [阶段 2c：回顾修订](#阶段-2c回顾修订)
- [阶段 3：收尾](#阶段-3收尾)
- [关键原则](#关键原则)

## 启动方式

- 用户输入 `/xdecide` 时激活

### 参数处理（`$ARGUMENTS`）

- **空** → 正常走阶段 1 询问
- **`reinit`** → 删除 SKILL-STATE.md 中 `## xdecide` 段（`python3 .claude/skills/xbase/skill-state.py delete xdecide`）+ 重新执行阶段 0
- **`review`** → 跳过阶段 1，直接进入阶段 2c 回顾修订
- **其他文本** → 作为决策描述，跳过阶段 1 直接进入阶段 2a 引导式决策（背景自动跳过）

## 核心文件

| 文件 | 说明 | 格式规范 |
|------|------|----------|
| `DECIDE-LOG.md` | 决策条目（编号递增，含背景/选项/结论） | `references/decision-format.md` |

## 流程

### 预加载状态
!`python3 .claude/skills/xbase/skill-state.py check xdecide 2>/dev/null`
!`python3 .claude/skills/xbase/skill-state.py read 2>/dev/null`

### 阶段 0：探测项目

> 按 `references/phase0-template.md` 标准流程执行。特有探测步骤：

1. **探测 DECIDE-LOG.md**：搜索 `DECIDE-LOG.md` 或文件名含 `决策记录`、`decision`、`ADR` 等关键词的文件（搜索范围：文档目录及项目根目录）。找到已有文件时优先使用，不强制重命名。
2. **三态检测**：
   - **不存在** → 在 `output_dir` 下创建 `DECIDE-LOG.md`（格式见 `references/decision-format.md`）
   - **存在但格式不符**（无 `## D-NNN` 标题行）→ AskUserQuestion 询问是否迁移
   - **已就绪** → 用 `decision-log.py list` 获取现有条目，展示概览
3. **写入**：`python3 .claude/skills/xbase/skill-state.py write xdecide decision_log "<路径>"`

4. **去重子步骤**（阶段 0 最后执行）：

   产出物创建/确认就绪后，扫描 CLAUDE.md 和 MEMORY.md，将本 skill 产出物已覆盖的详细内容替换为指针。

   **原则**：
   - 每次对话都需要的**方法论/禁令/哲学** → 保留原文
   - 已被产出物详细覆盖的**具体规范** → 替换为一句话 + 文件路径
   - 修改前展示 diff 预览，等用户确认

   **去重职责**：
   - MEMORY.md 中决策记录格式说明（如有）→ 替换为指向 DECIDE-LOG.md 文件顶部的指针
   - CLAUDE.md 中「任何产品/技术决策必须记录到 DECIDE-LOG.md」→ **保留**（这是禁令/方法论）

### 阶段 1：选择模式

用 AskUserQuestion：

```
问题：决策记录。选择操作：
选项：
- 新决策（引导式）
- 快速录入
- 回顾已有决策
- Other → 直接描述决策主题
```

### 阶段 2a：引导式决策

**步骤 1 — 理清背景**：

> 如果从其他 skill 衔接调用（如 xdebug/xreview 提供了上下文），且参数已包含决策描述，跳过此步骤。

用 AskUserQuestion：

```
问题：这次要决策什么？请描述背景和问题。
选项：
- Other → 用户输入背景描述
```

**步骤 2 — 分析方案**：

1. 扫描相关代码，理解当前实现和约束
2. 用 `decision-log.py search` 搜索历史相关决策，避免重复或矛盾
3. 分析可行方案，列出利弊

用 AskUserQuestion：

```
问题：基于分析，有以下方案：
  1. 方案 A — [描述]（优势：...；劣势：...）
  2. 方案 B — [描述]（优势：...；劣势：...）
  [3. 方案 C — ...]
  推荐方案 X，理由：...
  选择：
选项：
- 方案 A
- 方案 B
- [方案 C]
- Other → 补充信息或提出其他方案
```

**步骤 3 — 确认结论**：

获取下一个编号，格式化预览完整决策：

```bash
python3 .claude/skills/xbase/decision-log.py next-id <决策记录路径>
```

用 AskUserQuestion：

```
问题：决策预览：

  ## D-NNN 标题
  **背景**：...
  **选项**：
  1. ...
  2. ...
  **结论**：方案 X — ...

  确认写入？
选项：
- 确认写入
- 修改后写入
- 取消
```

**步骤 4 — 写入**：

用 Edit 工具在决策记录文件末尾追加决策内容（在最后一个 `---` 后追加）。

### 阶段 2b：快速录入

用 AskUserQuestion 获取决策描述：

```
问题：请简要描述决策（一句话背景 + 结论）：
选项：
- Other → 用户输入
```

自动格式化为标准决策条目（可省略选项），获取编号后预览确认，然后写入。

### 阶段 2c：回顾修订

1. 用 `decision-log.py list` 展示所有决策
2. 用 AskUserQuestion 选择条目：

```
问题：选择要查看的决策：
选项：
- D-001 标题1
- D-002 标题2
- D-003 标题3
- Other → 输入编号或搜索关键词
```

> 如果条目超过 4 个，展示最近 3 个 + Other（可输入编号或关键词搜索）

3. 读取并展示完整内容
4. 用 AskUserQuestion：

```
问题：查看 D-NNN 后，下一步？
选项：
- 追加修订（在原条目后补充新信息）
- 查看相关代码（搜索代码中引用此决策的位置）
- 查看其他决策
- 结束
```

**修订操作**：在原条目末尾（`---` 分隔线之前）追加修订段：
```markdown
**修订（YYYY-MM-DD）**：[修订内容]
```
不删除原始内容。

### 阶段 3：收尾

用 AskUserQuestion：

```
问题：决策记录完成。下一步？
选项：
- 继续下一条决策（→ 回阶段 1）
- 提交变更（→ /xcommit）
- 结束
```

---

## 关键原则

- **兼容已有** — 优先使用已有决策记录文件，新建时默认 `DECIDE-LOG.md`
- **引导而非代替** — 分析方案并给出推荐，但最终由用户选择
- **推荐带理由** — 每个推荐都说明为什么
- **历史感知** — 新决策前搜索相关历史决策，避免重复或矛盾
- **快速录入不打折** — 即使简化流程，仍确保格式完整
- **修订不删除** — 回顾修订时在原条目追加，保留决策演化历史
- **扫描代码不猜测** — 方案分析基于实际代码，不凭空臆测
- **选项优先于打字** — Other 兜底自由输入
- **每轮只问一个问题** — 不堆叠

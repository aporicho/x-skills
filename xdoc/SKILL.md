---
name: xdoc
description: 文档维护工作流。用户输入 /xdoc 时激活。基于 DOC-RULES.md 进行文档健康检查 + 代码-文档一致性验证。
allowed-tools: ["Bash", "Read", "Edit", "Write", "Grep", "Glob", "AskUserQuestion", "Task"]
argument-hint: "[健康检查 | 一致性 | reinit]"
---

# 文档维护工作流

## 目录

- [阶段 0：探测项目](#阶段-0探测项目)
- [阶段 1：选择任务](#阶段-1选择任务)
- [阶段 2a：健康检查](#阶段-2a健康检查)
- [阶段 2b：一致性验证](#阶段-2b一致性验证)
- [阶段 3：修复](#阶段-3修复)
- [阶段 4：汇报](#阶段-4汇报)
- [关键原则](#关键原则)

## 启动方式

- 用户输入 `/xdoc` 时激活

### 参数处理（`$ARGUMENTS`）

- **空** → 正常走阶段 1 询问
- **`reinit`** → 删除 SKILL-STATE.md 中 `## xdoc` 段（`python3 .claude/skills/xbase/skill-state.py delete xdoc`）+ 重新执行阶段 0
- **`健康检查`** → 跳过阶段 1，直接进入阶段 2a
- **`一致性`** → 跳过阶段 1，直接进入阶段 2b
- **其他文本** → 作为指定文件/目录路径，执行该路径的健康检查

## 核心文件

| 文件 | 说明 | 格式规范 |
|------|------|----------|
| `DOC-RULES.md` | 文档规范（目录结构 + 检查脚本 + 映射规则） | `references/doc-rules-format.md` |

## 流程

### 预加载状态
!`python3 .claude/skills/xbase/skill-state.py check xdoc 2>/dev/null`
!`python3 .claude/skills/xbase/skill-state.py read 2>/dev/null`

### 阶段 0：探测项目

> 按 `references/phase0-template.md` 标准流程执行。特有探测步骤：

1. **DOC-RULES.md 三态检测**：
   - **不存在** → 在 `output_dir` 下生成（执行步骤 2）
   - **存在但格式不符**（缺少「文档目录结构」「检查脚本」「代码-文档映射」等章节）→ 用 AskUserQuestion 问是否重新生成（保留旧文件为 `.bak`）
   - **已就绪** → 跳过生成，直接步骤 3

2. **生成 DOC-RULES.md**（按 `references/doc-rules-format.md` 格式）：

   规则来源两层：

   **a) CLAUDE.md 提取**（如存在）：
   - **文档优先级**：搜索"文档"/"document"/"优先"等关键词，提取文档权威性规则
   - **维护要求**：搜索"必须"/"更新"/"同步"等关键词，提取文档维护要求
   - **批量编辑规则**：搜索"批量"/"verify"/"验证"等关键词，提取批量编辑验证要求

   **b) 项目扫描**（始终执行，不依赖 CLAUDE.md 存在）：
   - **文档目录**：搜索 `docs/`/`doc/`/`document/`/`documentation/` 等候选，确认主文档目录及子目录结构
   - **检查脚本**：在 `scripts/` 目录下搜索 `link`/`check_link`/`structure`/`check_structure`/`index`/`generate_index`/`doc`/`verify` 等关键词的脚本，逐个确认功能
   - **编辑验证脚本**：搜索 `verify_edits` 等批量编辑验证脚本
   - **格式规范**：扫描 markdown 文件推导标题风格、代码块标注、注释语言等
   - **代码-文档映射**：扫描项目中的 DEBUG-LOG.md、DECIDE-LOG.md 等文件，推导变更类型→文档映射

   来源标记：每条规则标注来源为 `CLAUDE.md` 或 `项目扫描`，便于维护。

3. **写入状态**：`python3 .claude/skills/xbase/skill-state.py write xdoc doc_rules <DOC-RULES.md路径>`

4. **去重子步骤**（阶段 0 最后执行）：

   产出物创建/确认就绪后，扫描 CLAUDE.md 和 MEMORY.md，将本 skill 产出物已覆盖的详细内容替换为指针。

   **原则**：
   - 每次对话都需要的**方法论/禁令/哲学** → 保留原文
   - 已被产出物详细覆盖的**具体规范** → 替换为一句话 + 文件路径
   - 修改前展示 diff 预览，等用户确认

   **去重职责**：
   - xdoc 当前无对应的 CLAUDE.md / MEMORY.md 重复内容 → **跳过**

### 阶段 1：选择任务

用 AskUserQuestion：

```
问题：文档维护。选择操作：
选项：
- 健康检查（断链、格式、结构）
- 一致性验证（代码 ↔ 文档）
- 指定文件检查
- Other → 输入具体需求
```

### 阶段 2a：健康检查

读取 DOC-RULES.md 获取检查规则：

1. **运行检查脚本**（从 DOC-RULES.md「检查脚本」列表获取）：
   - 逐个运行，捕获输出
   - 汇总每个脚本发现的问题

2. **格式规范检查**（按 DOC-RULES.md「格式规范」执行）：
   - 扫描 markdown 文件中的链接，验证内部链接指向的文件存在
   - 检查标题层级规范
   - 检查代码块是否标注语言
   - 检查是否存在空文件或只有标题的占位文件

3. **汇总问题清单**：按严重程度排序（断链 > 格式 > 建议）

### 阶段 2b：一致性验证

1. **获取最近代码变更**：
   - 运行 `git log --oneline -20` 查看最近提交
   - 运行 `git diff HEAD~5..HEAD --stat` 查看最近 5 次提交的变更文件

2. **读取 DOC-RULES.md「代码-文档映射」**，对照变更文件识别应更新的文档

3. **检查映射项是否一致**：
   - 代码变更的提交中是否包含对应文档更新
   - 文档描述是否与当前代码一致

4. **汇总不一致清单**

### 阶段 3：修复

对汇总的问题清单，逐项用 AskUserQuestion：

```
问题：[问题类型] [文件路径]
  问题：[描述]
  建议修复：[方案]
选项：
- 自动修复
- 手动处理（跳过）
- 忽略
```

选择"自动修复"时：执行修复，确认结果。

**批量修复后验证**：如果修改了 10 个以上文件，按 DOC-RULES.md「批量编辑验证」中指定的脚本运行验证。

### 阶段 4：汇报

用 AskUserQuestion：

```
问题：文档维护完成。
  检查 N 个文件，发现 X 个问题（已修复 Y / 跳过 Z）。
  下一步？
选项：
- 重新检查（确认修复效果）
- 提交变更（→ /xcommit）
- 结束
```

---

## 关键原则

- **规则从文件读取** — 文档目录、检查脚本、映射规则基于 DOC-RULES.md，`reinit` 时重新生成
- **脚本优先** — DOC-RULES.md 中有检查脚本就用，没有才用内置基础检查
- **逐项决策** — 每个问题单独决策，不批量处理
- **批量修复后验证** — 10+ 文件修改后按 DOC-RULES.md 运行验证脚本
- **一致性检查优先最近变更** — 聚焦最近几次提交，不全量扫描
- **选项优先于打字** — Other 兜底自由输入
- **每轮只问一个问题** — 不堆叠
